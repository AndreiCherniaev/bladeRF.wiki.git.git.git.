This guide describes the process of building and installing the bladeRF host libraries and tool for a Linux system, and quickly getting a device up and running using pre-built firmware and FPGA images.

== Installing dependencies ==

'''NOTE:''' If your distribution provides libusb-1.0 packages earlier than 1.0.16, you may want to consider to manually installing libusb >= 1.0.16, either from source or from upstream packages.

While it is possible to use >= libusb-1.0.12, the bladeRF-flash utility will not be available due to hotplug support not being added until libusb-1.0.16. Versions earlier than libusb-1.0.12 are not supported.

If your distribution does not provide a [[libtecla|http://www.astro.caltech.edu/~mcs/tecla]] package (e.g., Fedora), it's recommended that you build it from source, as it makes the bladeRF-cli interactive mode much nicer to use!

=== Debian-based distros (e.g., Ubuntu) ===
Install dependent packages for the build:
<pre>$ sudo apt-get install libusb-1.0-0-dev libusb-1.0-0 build-essential cmake libncurses5-dev libtecla1 libtecla1-dev pkg-config git</pre>

You can check the libusb and libusb-dev versions installed on your system via:
<pre>
$ dpkg -s libusb-1.0-0 libusb-1.0-0-dev 
</pre>

'''(Optional)''' For Ubuntu users, the libusb-1.0.16 can be fetched from the upstream sources at http://packages.ubuntu.com/saucy/libusb-1.0-0 and http://packages.ubuntu.com/saucy/libusb-1.0-0-dev via:
<pre>$ wget http://de.archive.ubuntu.com/ubuntu/pool/main/libu/libusbx/libusb-1.0-0_1.0.16-3_amd64.deb && sudo dpkg -i libusb-1.0-0_1.0.16-3_amd64.deb
$ wget http://de.archive.ubuntu.com/ubuntu/pool/main/libu/libusbx/libusb-1.0-0-dev_1.0.16-3_amd64.deb && sudo dpkg -i libusb-1.0-0-dev_1.0.16-3_amd64.deb</pre>

=== Redhat-based distros (e.g., Fedora, CentOS) ===
<pre>
$ sudo yum groupinstall "Development Tools" "Development Libraries"
$ sudo yum install libusbx libusbx-devel cmake
</pre>

== Building bladeRF libraries and tools from source ==

=== Clone the bladeRF git repository ===

To obtain the latest source code for the first time, clone the Nuand git repository via:
<pre>
$ git clone https://github.com/Nuand/bladeRF.git ./bladeRF
$ cd ./bladeRF
$ ls  
</pre>


The directory contents will look something like this:
<pre>
CMakeLists.txt  COPYING          fx3_firmware  host
CONTRIBUTORS    firmware_common  hdl           README.md
</pre>

In the future, you can update the repository via:
<pre>
$ git pull
</pre>

=== Configure the build ===

First enter the directory containing the host source. Then create and enter a directory to perform the build in. By working out of the a 'build' directory, it's easy to later clean up, by simply removing 'build/'.

<pre>
$ cd host/
$ mkdir build
$ cd build
</pre>


Next, configure the build. In the below example, we:
* Set up a Debug build
* Enable the installation of udev rules. 
** By default, this grant members of the ''plugdev'' group read-write access to bladeRF devices.  This group can can be changed via ''-DBLADERF_GROUP''. The remainder of this guide assumes the default.
* Specify that files should be installed into /usr/local
** You can install into a different location via the ''-DCMAKE_INSTALL_PREFIX=/some/desired/path'' option. Note that you'll need to need to configure binary and library search paths if you install elsewhere. If you're unsure how to do this, simply follow the steps below to use the default install location.

<pre>
$ cmake -DCMAKE_BUILD_TYPE=Debug -DINSTALL_UDEV_RULES=ON ../
</pre>


Ensure that your user is in the group specified by ''BLADERF_GROUP'' (plugdev, by default).  Check the output of the ''groups'' command:

<pre>
$ groups                                                       ~
jon adm cdrom sudo dip plugdev lpadmin sambashare
</pre>

In the above case (an Ubuntu 13.10 system), the user is already in the ''plugdev'' group, so we can skip ahead to the next subsection.


However, on a Fedora 19 system, the user will not be in many groups. Furthermore, this distro doesn't have normally create and use a ''plugdev'' group.  We can create one as follows:
<pre>
$ groups                                                       ~
jon wheel
$ sudo groupadd plugdev
$ sudo usermod -a -G plugdev jon

# Now log out and log back in...

$ groups
jon wheel plugdev
</pre>

=== Perform the build and installation ===

The following commands:
# Perform the build
# Install files to /usr/local or the location specified by ''DCMAKE_INSTALL_PREFIX''
# Updated share library paths, so that libbladeRF can be found

<pre>
$ make
$ sudo make install
$ sudo ldconfig
</pre>

=== Uninstalling later ===
Note that from this same directory, you can run the following to uninstall the files place on your system in the previous step. <pre>sudo make uninstall</pre> 

The ''install_manifest.txt'' file, created after running the install step successfully, lists all the files installed.  It is a good idea to back up this file if you plan on removing this build directory later.

== Checking basic device operation ==

== Detecting the bladeRF ==
With the libraries and tools installed, we can now use the ''bladeRF-cli'' (command line interface) to probe for devices attached to the system.

First, take a look at the command-line options:
<pre>
$ bladeRF-cli --help
</pre>

Note that the ''-p'' option may be used to probe for device. Plug in your device, and run the following command. You should see similar output.

<pre>
$ bladeRF-cli -p
    Backend:        libusb
    Serial:         f12ce1037830a1b27f3ceeba1f521413
    USB Bus:        4
    USB Address:    8
</pre>

If you do not see any device listed:
* Verify that your user is in the ''plugdev'' group
* Double check ''dmesg'' and ''lsusb'' output
** The bladeRF's VID=1d50 and PID=6066
** If you see a Cypress device with VID=04b4 PID=00f3, then the bladeRF is running in the bootloader mode. No worries! Follow the instructions at: (Coming soon)
* See the Troubleshooting page (Coming soon) before continuing.

== Viewing additional device information ==

More information about the attached device can be viewed while running ''bladeRF-cli'' in interactive mode. Enter this mode and issue the '''help''' command to see a list of available command.  Use the '''info''' command to print information about the device, and '''version''' to view version information, most notably, the firmware:

<pre>
$ bladeRF-cli -i

bladeRF> help

... (Help text shown here ) ...

bladeRF> info

  Serial #:                 f12ce1037830a1b27f3ceeba1f521413                          
  VCTCXO DAC calibration:   0x894e
  FPGA size:                40 KLE
  FPGA loaded:              no
  USB bus:                  2
  USB address:              3
  USB speed:                Hi-Speed
  Backend:                  libusb
  Instance:                 0

bladeRF> version
  bladeRF-cli version:        0.6.0-git-f1f1c25
  libbladeRF version:         0.7.0-git-f1f1c25

  Firmware version:           1.0.0
  FPGA version:               Unknown (FPGA not loaded)

</pre>

Here we see the device's serial number, DAC calibration, FPGA information, and USB connection information.  Take note of the FPGA size, as this will help determine which FPGA file to load.


'''Note:''' If you see the following message, it is required that you update the firmware before continuing to the next section.  See [[Upgrading-bladeRF-firmware|this wiki page]] for more information on updating your firmware.
<pre>
********************************************************************************
* ENTERING LEGACY MODE, PLEASE UPGRADE TO THE LATEST FIRMWARE BY RUNNING:
* wget http://nuand.com/fx3/latest.img ; bladeRF-cli -f latest.img
********************************************************************************
</pre>

== Loading the FPGA ==
Support for loading the FPGA from flash automatically is currently supported and undergoing further testing. See the bladeRF-cli ''--help'' text for information on how to write an FPGA image to flash for autoloading.

For simplicity, this guide shows how to load the FPGA without storing it into flash for autoloading. (As a result, you'll have to load the FPGA each time the device is reset or plugged in.)

FPGA images can be obtained from [http://www.nuand.com/fpga|the Nuand website] or from a [http://hoopycat.com/bladerf_builds/|nightly build of "bleeding edge" images].

To load an image from the command line.
<pre>
$ bladeRF-cli -l <path/to/fpga/file>
</pre>

Or to load an image while in interactive mode:
<pre>
bladeRF> load fpga <path/to/fpga/file>
</pre>

At this point, you're ready to start using your device!

== Building GNU Radio and gr-osmosdr ==

The following procedure uses gnuradio-build to fetch dependencies and checkout some useful tools. However, it only covers installing GNU Radio and gr-osmosdr.  A similar procedure maybe used to install the other tools (such as gr-iqbal).

=== Using gnuradio-build to pull and check dependencies ===
Below, a "sandbox" directory will be used to do the build. Change this to whatever your preferred build directory is.

<pre>
$ cd ~/sandbox
$ mkdir gnuradio-builds
$ cd gnuradio-builds
$ wget http://www.sbrac.org/files/build-gnuradio
$ chmod +x ./build-gnuradio
$ ./build-gnuradio -m prereqs gitfetch
</pre>
Note that this takes quite a bit of time, depending on how many dependencies you need to have installed. Check **top** periodically to see what's currently being installed.

=== Compile GNU Radio ===
<pre>
$ cd ~/sandbox/gnuradio-builds/gnuradio/
$ mkdir build
$ cd build
$ cmake -DCMAKE_INSTALL_PREFIX=/opt/gnuradio-3.7.1git  ../ (based on git release, change as needed)
$ make
</pre>
( This is a large build and will take some time..  good time to take a break..)
<pre>$ sudo make install</pre>

=== Add GNU Radio to linker path and executable path ===
Create a new file called /etc/profile.d/gnuradio.sh
<pre>sudo vi /etc/profile.d/gnuradio.sh</pre>

Put the following into it:
<pre>#!/bin/bash
# Add GNU Radio binaries to the search path
export PATH=$PATH:/opt/gnuradio-3.7.1git/bin
# Add GNU Radio python libraries to python search path
if [ $PYTHONPATH ]; then
        export PYTHONPATH=$PYTHONPATH:/opt/gnuradio-3.7.1git/lib/python2.7/dist-packages
else
        export PYTHONPATH=/opt/gnuradio-3.7.1git/lib/python2.7/dist-packages
fi</pre>
'''Note: update the path above if you deviated from gnuradio-3.7.1git'''

'''Note: If you're on some non-debian based distro, you might need to replace "dist-packages" with "site-packages".'''

Again, with your favorite text editor, create a new file call /etc/ld.so.conf.d/gnuradio.conf
you will need sudo for this again.. (one line file)
<pre>sudo vi /etc/ld.so.conf.d/gnuradio.conf</pre>
Put this in the new file:
<pre>/opt/gnuradio-3.7.1git/lib</pre>
'''(note:) on some 64 bit systems, you might need a lib64 directory in this file as well?'''

* now update your library cache
<pre>$ sudo ldconfig -v | grep gnuradio</pre>

You should see something akin to the following:
<pre>/opt/gnuradio-3.7.1git/lib:
        libgnuradio-atsc-3.7.1git.so.0.0.0 -> libgnuradio-atsc.so
        libgnuradio-trellis-3.7.1git.so.0.0.0 -> libgnuradio-trellis.so
        libgnuradio-analog-3.7.1git.so.0.0.0 -> libgnuradio-analog.so
        libgnuradio-pager-3.7.1git.so.0.0.0 -> libgnuradio-pager.so
        libgnuradio-vocoder-3.7.1git.so.0.0.0 -> libgnuradio-vocoder.so
        libgnuradio-video-sdl-3.7.1git.so.0.0.0 -> libgnuradio-video-sdl.so
        libgnuradio-pmt-3.7.1git.so.0.0.0 -> libgnuradio-pmt.so
        libgnuradio-noaa-3.7.1git.so.0.0.0 -> libgnuradio-noaa.so
        libgnuradio-filter-3.7.1git.so.0.0.0 -> libgnuradio-filter.so
        libgnuradio-digital-3.7.1git.so.0.0.0 -> libgnuradio-digital.so
        libgnuradio-channels-3.7.1git.so.0.0.0 -> libgnuradio-channels.so
        libgnuradio-qtgui-3.7.1git.so.0.0.0 -> libgnuradio-qtgui.so
        libgnuradio-wxgui-3.7.1git.so.0.0.0 -> libgnuradio-wxgui.so
        libgnuradio-fec-3.7.1git.so.0.0.0 -> libgnuradio-fec.so
        libgnuradio-wavelet-3.7.1git.so.0.0.0 -> libgnuradio-wavelet.so
        libgnuradio-fcd-3.7.1git.so.0.0.0 -> libgnuradio-fcd.so
        libgnuradio-blocks-3.7.1git.so.0.0.0 -> libgnuradio-blocks.so
        libgnuradio-fft-3.7.1git.so.0.0.0 -> libgnuradio-fft.so
        libgnuradio-runtime-3.7.1git.so.0.0.0 -> libgnuradio-runtime.so
        libgnuradio-audio-3.7.1git.so.0.0.0 -> libgnuradio-audio.so
</pre>

If so, you're all set!

You will now need to logout and log back in for the profile.d settings to take effect.
Once you have logged back in to your desktop, you should be able to run gnuradio-companion.
If you get a pop up about PYTHONPATH or LD_LIBRARY_PATH, check env to see if the python path or ldconfig returns the correct libraries.

=== Fetch and build gr-osmosdr ===
* Pull the git version of gr-osmosdr, build, install
<pre>$ cd ~/sandbox
$ git clone git://git.osmocom.org/gr-osmosdr ./gr-osmosdr
$ mkdir ~/sandbox/gr-osmosdr/build
$ cd ~/sandbox/gr-osmosdr/build
$ cmake -DCMAKE_INSTALL_PREFIX=/opt/gnuradio-3.7.1git ../
$ make
$ sudo make install
</pre>

=== Simple test applications to verify device operation ===
*Using osmocom stand-alone applications:
Test Receive: (446 MHz)
<pre>osmocom_fft -a bladerf=0,fpga=<your FPGA image> -s 8000000 -f 446000000</pre>
Test Transmit: (446 MHz + 25 KHz )
<pre>osmocom_siggen -a bladerf=0,fpga=<our FPGA image> -s 8000000 -f 446000000 -g 4 --sine -x 25000</pre>